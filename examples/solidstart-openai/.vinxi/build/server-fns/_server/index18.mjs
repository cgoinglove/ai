import{c as Pe,F as I,G as E,e as Ie,v as ve,s as Re,U as He,H as mt,J as Ke,K as Ht,h as or,j as Kt,k as ga,L as va,M as ya,N as wa,C as _t,z as ft,a as ba,O as It,P as ir,Q as xa}from"./index17.mjs";import{z as i}from"zod";var Sa=typeof globalThis=="object"?globalThis:global,ye="1.9.0",Yt=/^(\d+)\.(\d+)\.(\d+)(-(.+))?$/;function Ta(e){var t=new Set([e]),r=new Set,a=e.match(Yt);if(!a)return function(){return!1};var s={major:+a[1],minor:+a[2],patch:+a[3],prerelease:a[4]};if(s.prerelease!=null)return function(c){return c===e};function n(l){return r.add(l),!1}function o(l){return t.add(l),!0}return function(c){if(t.has(c))return!0;if(r.has(c))return!1;var u=c.match(Yt);if(!u)return n(c);var d={major:+u[1],minor:+u[2],patch:+u[3],prerelease:u[4]};return d.prerelease!=null||s.major!==d.major?n(c):s.major===0?s.minor===d.minor&&s.patch<=d.patch?o(c):n(c):s.minor<=d.minor?o(c):n(c)}}var _a=Ta(ye),Ia=ye.split(".")[0],ke=Symbol.for("opentelemetry.js.api."+Ia),De=Sa;function Rt(e,t,r,a){var s;a===void 0&&(a=!1);var n=De[ke]=(s=De[ke])!==null&&s!==void 0?s:{version:ye};if(!a&&n[e]){var o=new Error("@opentelemetry/api: Attempted duplicate registration of API: "+e);return r.error(o.stack||o.message),!1}if(n.version!==ye){var o=new Error("@opentelemetry/api: Registration of version v"+n.version+" for "+e+" does not match previously registered API v"+ye);return r.error(o.stack||o.message),!1}return n[e]=t,r.debug("@opentelemetry/api: Registered a global for "+e+" v"+ye+"."),!0}function qe(e){var t,r,a=(t=De[ke])===null||t===void 0?void 0:t.version;if(!(!a||!_a(a)))return(r=De[ke])===null||r===void 0?void 0:r[e]}function Ct(e,t){t.debug("@opentelemetry/api: Unregistering a global for "+e+" v"+ye+".");var r=De[ke];r&&delete r[e]}var Ra=function(e,t){var r=typeof Symbol=="function"&&e[Symbol.iterator];if(!r)return e;var a=r.call(e),s,n=[],o;try{for(;(t===void 0||t-- >0)&&!(s=a.next()).done;)n.push(s.value)}catch(l){o={error:l}}finally{try{s&&!s.done&&(r=a.return)&&r.call(a)}finally{if(o)throw o.error}}return n},Ca=function(e,t,r){if(r||arguments.length===2)for(var a=0,s=t.length,n;a<s;a++)(n||!(a in t))&&(n||(n=Array.prototype.slice.call(t,0,a)),n[a]=t[a]);return e.concat(n||Array.prototype.slice.call(t))},Pa=function(){function e(t){this._namespace=t.namespace||"DiagComponentLogger"}return e.prototype.debug=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return Ne("debug",this._namespace,t)},e.prototype.error=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return Ne("error",this._namespace,t)},e.prototype.info=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return Ne("info",this._namespace,t)},e.prototype.warn=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return Ne("warn",this._namespace,t)},e.prototype.verbose=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return Ne("verbose",this._namespace,t)},e}();function Ne(e,t,r){var a=qe("diag");if(a)return r.unshift(t),a[e].apply(a,Ca([],Ra(r),!1))}var W;(function(e){e[e.NONE=0]="NONE",e[e.ERROR=30]="ERROR",e[e.WARN=50]="WARN",e[e.INFO=60]="INFO",e[e.DEBUG=70]="DEBUG",e[e.VERBOSE=80]="VERBOSE",e[e.ALL=9999]="ALL"})(W||(W={}));function Ea(e,t){e<W.NONE?e=W.NONE:e>W.ALL&&(e=W.ALL),t=t||{};function r(a,s){var n=t[a];return typeof n=="function"&&e>=s?n.bind(t):function(){}}return{error:r("error",W.ERROR),warn:r("warn",W.WARN),info:r("info",W.INFO),debug:r("debug",W.DEBUG),verbose:r("verbose",W.VERBOSE)}}var Aa=function(e,t){var r=typeof Symbol=="function"&&e[Symbol.iterator];if(!r)return e;var a=r.call(e),s,n=[],o;try{for(;(t===void 0||t-- >0)&&!(s=a.next()).done;)n.push(s.value)}catch(l){o={error:l}}finally{try{s&&!s.done&&(r=a.return)&&r.call(a)}finally{if(o)throw o.error}}return n},ja=function(e,t,r){if(r||arguments.length===2)for(var a=0,s=t.length,n;a<s;a++)(n||!(a in t))&&(n||(n=Array.prototype.slice.call(t,0,a)),n[a]=t[a]);return e.concat(n||Array.prototype.slice.call(t))},Ma="diag",Ye=function(){function e(){function t(s){return function(){for(var n=[],o=0;o<arguments.length;o++)n[o]=arguments[o];var l=qe("diag");if(l)return l[s].apply(l,ja([],Aa(n),!1))}}var r=this,a=function(s,n){var o,l,c;if(n===void 0&&(n={logLevel:W.INFO}),s===r){var u=new Error("Cannot use diag as the logger for itself. Please use a DiagLogger implementation like ConsoleDiagLogger or a custom implementation");return r.error((o=u.stack)!==null&&o!==void 0?o:u.message),!1}typeof n=="number"&&(n={logLevel:n});var d=qe("diag"),m=Ea((l=n.logLevel)!==null&&l!==void 0?l:W.INFO,s);if(d&&!n.suppressOverrideMessage){var v=(c=new Error().stack)!==null&&c!==void 0?c:"<failed to generate stacktrace>";d.warn("Current logger will be overwritten from "+v),m.warn("Current logger will overwrite one already registered from "+v)}return Rt("diag",m,r,!0)};r.setLogger=a,r.disable=function(){Ct(Ma,r)},r.createComponentLogger=function(s){return new Pa(s)},r.verbose=t("verbose"),r.debug=t("debug"),r.info=t("info"),r.warn=t("warn"),r.error=t("error")}return e.instance=function(){return this._instance||(this._instance=new e),this._instance},e}();function Na(e){return Symbol.for(e)}var Oa=function(){function e(t){var r=this;r._currentContext=t?new Map(t):new Map,r.getValue=function(a){return r._currentContext.get(a)},r.setValue=function(a,s){var n=new e(r._currentContext);return n._currentContext.set(a,s),n},r.deleteValue=function(a){var s=new e(r._currentContext);return s._currentContext.delete(a),s}}return e}(),ka=new Oa,Da=function(e,t){var r=typeof Symbol=="function"&&e[Symbol.iterator];if(!r)return e;var a=r.call(e),s,n=[],o;try{for(;(t===void 0||t-- >0)&&!(s=a.next()).done;)n.push(s.value)}catch(l){o={error:l}}finally{try{s&&!s.done&&(r=a.return)&&r.call(a)}finally{if(o)throw o.error}}return n},qa=function(e,t,r){if(r||arguments.length===2)for(var a=0,s=t.length,n;a<s;a++)(n||!(a in t))&&(n||(n=Array.prototype.slice.call(t,0,a)),n[a]=t[a]);return e.concat(n||Array.prototype.slice.call(t))},Ua=function(){function e(){}return e.prototype.active=function(){return ka},e.prototype.with=function(t,r,a){for(var s=[],n=3;n<arguments.length;n++)s[n-3]=arguments[n];return r.call.apply(r,qa([a],Da(s),!1))},e.prototype.bind=function(t,r){return r},e.prototype.enable=function(){return this},e.prototype.disable=function(){return this},e}(),$a=function(e,t){var r=typeof Symbol=="function"&&e[Symbol.iterator];if(!r)return e;var a=r.call(e),s,n=[],o;try{for(;(t===void 0||t-- >0)&&!(s=a.next()).done;)n.push(s.value)}catch(l){o={error:l}}finally{try{s&&!s.done&&(r=a.return)&&r.call(a)}finally{if(o)throw o.error}}return n},Fa=function(e,t,r){if(r||arguments.length===2)for(var a=0,s=t.length,n;a<s;a++)(n||!(a in t))&&(n||(n=Array.prototype.slice.call(t,0,a)),n[a]=t[a]);return e.concat(n||Array.prototype.slice.call(t))},lt="context",Ja=new Ua,lr=function(){function e(){}return e.getInstance=function(){return this._instance||(this._instance=new e),this._instance},e.prototype.setGlobalContextManager=function(t){return Rt(lt,t,Ye.instance())},e.prototype.active=function(){return this._getContextManager().active()},e.prototype.with=function(t,r,a){for(var s,n=[],o=3;o<arguments.length;o++)n[o-3]=arguments[o];return(s=this._getContextManager()).with.apply(s,Fa([t,r,a],$a(n),!1))},e.prototype.bind=function(t,r){return this._getContextManager().bind(t,r)},e.prototype._getContextManager=function(){return qe(lt)||Ja},e.prototype.disable=function(){this._getContextManager().disable(),Ct(lt,Ye.instance())},e}(),ht;(function(e){e[e.NONE=0]="NONE",e[e.SAMPLED=1]="SAMPLED"})(ht||(ht={}));var ur="0000000000000000",cr="00000000000000000000000000000000",Ba={traceId:cr,spanId:ur,traceFlags:ht.NONE},Oe=function(){function e(t){t===void 0&&(t=Ba),this._spanContext=t}return e.prototype.spanContext=function(){return this._spanContext},e.prototype.setAttribute=function(t,r){return this},e.prototype.setAttributes=function(t){return this},e.prototype.addEvent=function(t,r){return this},e.prototype.addLink=function(t){return this},e.prototype.addLinks=function(t){return this},e.prototype.setStatus=function(t){return this},e.prototype.updateName=function(t){return this},e.prototype.end=function(t){},e.prototype.isRecording=function(){return!1},e.prototype.recordException=function(t,r){},e}(),Pt=Na("OpenTelemetry Context Key SPAN");function Et(e){return e.getValue(Pt)||void 0}function Ga(){return Et(lr.getInstance().active())}function At(e,t){return e.setValue(Pt,t)}function La(e){return e.deleteValue(Pt)}function Wa(e,t){return At(e,new Oe(t))}function pr(e){var t;return(t=Et(e))===null||t===void 0?void 0:t.spanContext()}var Va=/^([0-9a-f]{32})$/i,za=/^[0-9a-f]{16}$/i;function Xa(e){return Va.test(e)&&e!==cr}function Ha(e){return za.test(e)&&e!==ur}function dr(e){return Xa(e.traceId)&&Ha(e.spanId)}function Ka(e){return new Oe(e)}var ut=lr.getInstance(),mr=function(){function e(){}return e.prototype.startSpan=function(t,r,a){a===void 0&&(a=ut.active());var s=!!r?.root;if(s)return new Oe;var n=a&&pr(a);return Ya(n)&&dr(n)?new Oe(n):new Oe},e.prototype.startActiveSpan=function(t,r,a,s){var n,o,l;if(!(arguments.length<2)){arguments.length===2?l=r:arguments.length===3?(n=r,l=a):(n=r,o=a,l=s);var c=o??ut.active(),u=this.startSpan(t,n,c),d=At(c,u);return ut.with(d,l,void 0,u)}},e}();function Ya(e){return typeof e=="object"&&typeof e.spanId=="string"&&typeof e.traceId=="string"&&typeof e.traceFlags=="number"}var Qa=new mr,Za=function(){function e(t,r,a,s){this._provider=t,this.name=r,this.version=a,this.options=s}return e.prototype.startSpan=function(t,r,a){return this._getTracer().startSpan(t,r,a)},e.prototype.startActiveSpan=function(t,r,a,s){var n=this._getTracer();return Reflect.apply(n.startActiveSpan,n,arguments)},e.prototype._getTracer=function(){if(this._delegate)return this._delegate;var t=this._provider.getDelegateTracer(this.name,this.version,this.options);return t?(this._delegate=t,this._delegate):Qa},e}(),en=function(){function e(){}return e.prototype.getTracer=function(t,r,a){return new mr},e}(),tn=new en,Qt=function(){function e(){}return e.prototype.getTracer=function(t,r,a){var s;return(s=this.getDelegateTracer(t,r,a))!==null&&s!==void 0?s:new Za(this,t,r,a)},e.prototype.getDelegate=function(){var t;return(t=this._delegate)!==null&&t!==void 0?t:tn},e.prototype.setDelegate=function(t){this._delegate=t},e.prototype.getDelegateTracer=function(t,r,a){var s;return(s=this._delegate)===null||s===void 0?void 0:s.getTracer(t,r,a)},e}(),Qe;(function(e){e[e.UNSET=0]="UNSET",e[e.OK=1]="OK",e[e.ERROR=2]="ERROR"})(Qe||(Qe={}));var ct="trace",rn=function(){function e(){this._proxyTracerProvider=new Qt,this.wrapSpanContext=Ka,this.isSpanContextValid=dr,this.deleteSpan=La,this.getSpan=Et,this.getActiveSpan=Ga,this.getSpanContext=pr,this.setSpan=At,this.setSpanContext=Wa}return e.getInstance=function(){return this._instance||(this._instance=new e),this._instance},e.prototype.setGlobalTracerProvider=function(t){var r=Rt(ct,this._proxyTracerProvider,Ye.instance());return r&&this._proxyTracerProvider.setDelegate(t),r},e.prototype.getTracerProvider=function(){return qe(ct)||this._proxyTracerProvider},e.prototype.getTracer=function(t,r){return this.getTracerProvider().getTracer(t,r)},e.prototype.disable=function(){Ct(ct,Ye.instance()),this._proxyTracerProvider=new Qt},e}(),an=rn.getInstance(),nn=Object.defineProperty,jt=(e,t)=>{for(var r in t)nn(e,r,{get:t[r],enumerable:!0})};function sn({execute:e,onError:t=()=>"An error occurred."}){let r;const a=[],s=new ReadableStream({start(l){r=l}});function n(l){try{r.enqueue(l)}catch{}}try{const l=e({write(c){n(c)},writeData(c){n(E("data",[c]))},writeMessageAnnotation(c){n(E("message_annotations",[c]))},writeSource(c){n(E("source",c))},merge(c){a.push((async()=>{const u=c.getReader();for(;;){const{done:d,value:m}=await u.read();if(d)break;n(m)}})().catch(u=>{n(E("error",t(u)))}))},onError:t});l&&a.push(l.catch(c=>{n(E("error",t(c)))}))}catch(l){n(E("error",t(l)))}return new Promise(async l=>{for(;a.length>0;)await a.shift();l()}).finally(()=>{try{r.close()}catch{}}),s}function Ce(e,{contentType:t,dataStreamVersion:r}){const a=new Headers(e??{});return a.has("Content-Type")||a.set("Content-Type",t),r!==void 0&&a.set("X-Vercel-AI-Data-Stream",r),a}function Zs({status:e,statusText:t,headers:r,execute:a,onError:s}){return new Response(sn({execute:a,onError:s}).pipeThrough(new TextEncoderStream),{status:e,statusText:t,headers:Ce(r,{contentType:"text/plain; charset=utf-8",dataStreamVersion:"v1"})})}function gt(e,{contentType:t,dataStreamVersion:r}){const a={};if(e!=null)for(const[s,n]of Object.entries(e))a[s]=n;return a["Content-Type"]==null&&(a["Content-Type"]=t),r!==void 0&&(a["X-Vercel-AI-Data-Stream"]=r),a}function vt({response:e,status:t,statusText:r,headers:a,stream:s}){e.writeHead(t??200,r,a);const n=s.getReader();(async()=>{try{for(;;){const{done:l,value:c}=await n.read();if(l)break;e.write(c)}}catch(l){throw l}finally{e.end()}})()}var fr="AI_InvalidArgumentError",hr=`vercel.ai.error.${fr}`,on=Symbol.for(hr),gr,R=class extends I{constructor({parameter:e,value:t,message:r}){super({name:fr,message:`Invalid argument for parameter ${e}: ${r}`}),this[gr]=!0,this.parameter=e,this.value=t}static isInstance(e){return I.hasMarker(e,hr)}};gr=on;var vr="AI_RetryError",yr=`vercel.ai.error.${vr}`,ln=Symbol.for(yr),wr,Zt=class extends I{constructor({message:e,reason:t,errors:r}){super({name:vr,message:e}),this[wr]=!0,this.reason=t,this.errors=r,this.lastError=r[r.length-1]}static isInstance(e){return I.hasMarker(e,yr)}};wr=ln;var un=({maxRetries:e=2,initialDelayInMs:t=2e3,backoffFactor:r=2}={})=>async a=>br(a,{maxRetries:e,delayInMs:t,backoffFactor:r});async function br(e,{maxRetries:t,delayInMs:r,backoffFactor:a},s=[]){try{return await e()}catch(n){if(ga(n)||t===0)throw n;const o=va(n),l=[...s,n],c=l.length;if(c>t)throw new Zt({message:`Failed after ${c} attempts. Last error: ${o}`,reason:"maxRetriesExceeded",errors:l});if(n instanceof Error&&ya.isInstance(n)&&n.isRetryable===!0&&c<=t)return await wa(r),br(e,{maxRetries:t,delayInMs:a*r,backoffFactor:a},l);throw c===1?n:new Zt({message:`Failed after ${c} attempts with non-retryable error: '${o}'`,reason:"errorNotRetryable",errors:l})}}function xr({maxRetries:e}){if(e!=null){if(!Number.isInteger(e))throw new R({parameter:"maxRetries",value:e,message:"maxRetries must be an integer"});if(e<0)throw new R({parameter:"maxRetries",value:e,message:"maxRetries must be >= 0"})}const t=e??2;return{maxRetries:t,retry:un({maxRetries:t})}}function Ue({operationId:e,telemetry:t}){return{"operation.name":`${e}${t?.functionId!=null?` ${t.functionId}`:""}`,"resource.name":t?.functionId,"ai.operationId":e,"ai.telemetry.functionId":t?.functionId}}function Sr({model:e,settings:t,telemetry:r,headers:a}){var s;return{"ai.model.provider":e.provider,"ai.model.id":e.modelId,...Object.entries(t).reduce((n,[o,l])=>(n[`ai.settings.${o}`]=l,n),{}),...Object.entries((s=r?.metadata)!=null?s:{}).reduce((n,[o,l])=>(n[`ai.telemetry.metadata.${o}`]=l,n),{}),...Object.entries(a??{}).reduce((n,[o,l])=>(l!==void 0&&(n[`ai.request.headers.${o}`]=l),n),{})}}var cn={startSpan(){return Xe},startActiveSpan(e,t,r,a){if(typeof t=="function")return t(Xe);if(typeof r=="function")return r(Xe);if(typeof a=="function")return a(Xe)}},Xe={spanContext(){return pn},setAttribute(){return this},setAttributes(){return this},addEvent(){return this},addLink(){return this},addLinks(){return this},setStatus(){return this},updateName(){return this},end(){return this},isRecording(){return!1},recordException(){return this}},pn={traceId:"",spanId:"",traceFlags:0};function Tr({isEnabled:e=!1,tracer:t}={}){return e?t||an.getTracer("ai"):cn}function $e({name:e,tracer:t,attributes:r,fn:a,endWhenDone:s=!0}){return t.startActiveSpan(e,{attributes:r},async n=>{try{const o=await a(n);return s&&n.end(),o}catch(o){try{o instanceof Error?(n.recordException({name:o.name,message:o.message,stack:o.stack}),n.setStatus({code:Qe.ERROR,message:o.message})):n.setStatus({code:Qe.ERROR})}finally{n.end()}throw o}})}function Z({telemetry:e,attributes:t}){return e?.isEnabled!==!0?{}:Object.entries(t).reduce((r,[a,s])=>{if(s===void 0)return r;if(typeof s=="object"&&"input"in s&&typeof s.input=="function"){if(e?.recordInputs===!1)return r;const n=s.input();return n===void 0?r:{...r,[a]:n}}if(typeof s=="object"&&"output"in s&&typeof s.output=="function"){if(e?.recordOutputs===!1)return r;const n=s.output();return n===void 0?r:{...r,[a]:n}}return{...r,[a]:s}},{})}var dn=class{constructor({data:e,mimeType:t}){const r=e instanceof Uint8Array;this.base64Data=r?void 0:e,this.uint8ArrayData=r?e:void 0,this.mimeType=t}get base64(){return this.base64Data==null&&(this.base64Data=ft(this.uint8ArrayData)),this.base64Data}get uint8Array(){return this.uint8ArrayData==null&&(this.uint8ArrayData=_t(this.base64Data)),this.uint8ArrayData}},mn=class extends dn{constructor(e){super(e),this.type="file"}},fn=[{mimeType:"image/gif",bytesPrefix:[71,73,70],base64Prefix:"R0lG"},{mimeType:"image/png",bytesPrefix:[137,80,78,71],base64Prefix:"iVBORw"},{mimeType:"image/jpeg",bytesPrefix:[255,216],base64Prefix:"/9j/"},{mimeType:"image/webp",bytesPrefix:[82,73,70,70],base64Prefix:"UklGRg"},{mimeType:"image/bmp",bytesPrefix:[66,77],base64Prefix:"Qk"},{mimeType:"image/tiff",bytesPrefix:[73,73,42,0],base64Prefix:"SUkqAA"},{mimeType:"image/tiff",bytesPrefix:[77,77,0,42],base64Prefix:"TU0AKg"},{mimeType:"image/avif",bytesPrefix:[0,0,0,32,102,116,121,112,97,118,105,102],base64Prefix:"AAAAIGZ0eXBhdmlm"},{mimeType:"image/heic",bytesPrefix:[0,0,0,32,102,116,121,112,104,101,105,99],base64Prefix:"AAAAIGZ0eXBoZWlj"}],hn=e=>{const t=typeof e=="string"?_t(e):e,r=(t[6]&127)<<21|(t[7]&127)<<14|(t[8]&127)<<7|t[9]&127;return t.slice(r+10)};function gn(e){return typeof e=="string"&&e.startsWith("SUQz")||typeof e!="string"&&e.length>10&&e[0]===73&&e[1]===68&&e[2]===51?hn(e):e}function vn({data:e,signatures:t}){const r=gn(e);for(const a of t)if(typeof r=="string"?r.startsWith(a.base64Prefix):r.length>=a.bytesPrefix.length&&a.bytesPrefix.every((s,n)=>r[n]===s))return a.mimeType}var _r="AI_NoObjectGeneratedError",Ir=`vercel.ai.error.${_r}`,yn=Symbol.for(Ir),Rr,Ze=class extends I{constructor({message:e="No object generated.",cause:t,text:r,response:a,usage:s,finishReason:n}){super({name:_r,message:e,cause:t}),this[Rr]=!0,this.text=r,this.response=a,this.usage=s,this.finishReason=n}static isInstance(e){return I.hasMarker(e,Ir)}};Rr=yn;var Cr="AI_DownloadError",Pr=`vercel.ai.error.${Cr}`,wn=Symbol.for(Pr),Er,pt=class extends I{constructor({url:e,statusCode:t,statusText:r,cause:a,message:s=a==null?`Failed to download ${e}: ${t} ${r}`:`Failed to download ${e}: ${a}`}){super({name:Cr,message:s,cause:a}),this[Er]=!0,this.url=e,this.statusCode=t,this.statusText=r}static isInstance(e){return I.hasMarker(e,Pr)}};Er=wn;async function bn({url:e}){var t;const r=e.toString();try{const a=await fetch(r);if(!a.ok)throw new pt({url:r,statusCode:a.status,statusText:a.statusText});return{data:new Uint8Array(await a.arrayBuffer()),mimeType:(t=a.headers.get("content-type"))!=null?t:void 0}}catch(a){throw pt.isInstance(a)?a:new pt({url:r,cause:a})}}var Ar="AI_InvalidDataContentError",jr=`vercel.ai.error.${Ar}`,xn=Symbol.for(jr),Mr,er=class extends I{constructor({content:e,cause:t,message:r=`Invalid data content. Expected a base64 string, Uint8Array, ArrayBuffer, or Buffer, but got ${typeof e}.`}){super({name:Ar,message:r,cause:t}),this[Mr]=!0,this.content=e}static isInstance(e){return I.hasMarker(e,jr)}};Mr=xn;var Nr=i.union([i.string(),i.instanceof(Uint8Array),i.instanceof(ArrayBuffer),i.custom(e=>{var t,r;return(r=(t=globalThis.Buffer)==null?void 0:t.isBuffer(e))!=null?r:!1},{message:"Must be a Buffer"})]);function Or(e){return typeof e=="string"?e:e instanceof ArrayBuffer?ft(new Uint8Array(e)):ft(e)}function et(e){if(e instanceof Uint8Array)return e;if(typeof e=="string")try{return _t(e)}catch(t){throw new er({message:"Invalid data content. Content string is not a base64-encoded media.",content:e,cause:t})}if(e instanceof ArrayBuffer)return new Uint8Array(e);throw new er({content:e})}function Sn(e){try{return new TextDecoder().decode(e)}catch{throw new Error("Error decoding Uint8Array to text")}}var kr="AI_InvalidMessageRoleError",Dr=`vercel.ai.error.${kr}`,Tn=Symbol.for(Dr),qr,_n=class extends I{constructor({role:e,message:t=`Invalid message role: '${e}'. Must be one of: "system", "user", "assistant", "tool".`}){super({name:kr,message:t}),this[qr]=!0,this.role=e}static isInstance(e){return I.hasMarker(e,Dr)}};qr=Tn;function In(e){try{const[t,r]=e.split(",");return{mimeType:t.split(";")[0].split(":")[1],base64Content:r}}catch{return{mimeType:void 0,base64Content:void 0}}}async function yt({prompt:e,modelSupportsImageUrls:t=!0,modelSupportsUrl:r=()=>!1,downloadImplementation:a=bn}){const s=await Cn(e.messages,a,t,r);return[...e.system!=null?[{role:"system",content:e.system}]:[],...e.messages.map(n=>Rn(n,s))]}function Rn(e,t){var r,a,s,n,o,l;const c=e.role;switch(c){case"system":return{role:"system",content:e.content,providerMetadata:(r=e.providerOptions)!=null?r:e.experimental_providerMetadata};case"user":return typeof e.content=="string"?{role:"user",content:[{type:"text",text:e.content}],providerMetadata:(a=e.providerOptions)!=null?a:e.experimental_providerMetadata}:{role:"user",content:e.content.map(u=>Pn(u,t)).filter(u=>u.type!=="text"||u.text!==""),providerMetadata:(s=e.providerOptions)!=null?s:e.experimental_providerMetadata};case"assistant":return typeof e.content=="string"?{role:"assistant",content:[{type:"text",text:e.content}],providerMetadata:(n=e.providerOptions)!=null?n:e.experimental_providerMetadata}:{role:"assistant",content:e.content.filter(u=>u.type!=="text"||u.text!=="").map(u=>{var d;const m=(d=u.providerOptions)!=null?d:u.experimental_providerMetadata;switch(u.type){case"file":return{type:"file",data:u.data instanceof URL?u.data:Or(u.data),filename:u.filename,mimeType:u.mimeType,providerMetadata:m};case"reasoning":return{type:"reasoning",text:u.text,signature:u.signature,providerMetadata:m};case"redacted-reasoning":return{type:"redacted-reasoning",data:u.data,providerMetadata:m};case"text":return{type:"text",text:u.text,providerMetadata:m};case"tool-call":return{type:"tool-call",toolCallId:u.toolCallId,toolName:u.toolName,args:u.args,providerMetadata:m}}}),providerMetadata:(o=e.providerOptions)!=null?o:e.experimental_providerMetadata};case"tool":return{role:"tool",content:e.content.map(u=>{var d;return{type:"tool-result",toolCallId:u.toolCallId,toolName:u.toolName,result:u.result,content:u.experimental_content,isError:u.isError,providerMetadata:(d=u.providerOptions)!=null?d:u.experimental_providerMetadata}}),providerMetadata:(l=e.providerOptions)!=null?l:e.experimental_providerMetadata};default:{const u=c;throw new _n({role:u})}}}async function Cn(e,t,r,a){const s=e.filter(o=>o.role==="user").map(o=>o.content).filter(o=>Array.isArray(o)).flat().filter(o=>o.type==="image"||o.type==="file").filter(o=>!(o.type==="image"&&r===!0)).map(o=>o.type==="image"?o.image:o.data).map(o=>typeof o=="string"&&(o.startsWith("http:")||o.startsWith("https:"))?new URL(o):o).filter(o=>o instanceof URL).filter(o=>!a(o)),n=await Promise.all(s.map(async o=>({url:o,data:await t({url:o})})));return Object.fromEntries(n.map(({url:o,data:l})=>[o.toString(),l]))}function Pn(e,t){var r,a,s,n;if(e.type==="text")return{type:"text",text:e.text,providerMetadata:(r=e.providerOptions)!=null?r:e.experimental_providerMetadata};let o=e.mimeType,l,c,u;const d=e.type;switch(d){case"image":l=e.image;break;case"file":l=e.data;break;default:throw new Error(`Unsupported part type: ${d}`)}try{c=typeof l=="string"?new URL(l):l}catch{c=l}if(c instanceof URL)if(c.protocol==="data:"){const{mimeType:m,base64Content:v}=In(c.toString());if(m==null||v==null)throw new Error(`Invalid data URL format in part ${d}`);o=m,u=et(v)}else{const m=t[c.toString()];m?(u=m.data,o??(o=m.mimeType)):u=c}else u=et(c);switch(d){case"image":return u instanceof Uint8Array&&(o=(a=vn({data:u,signatures:fn}))!=null?a:o),{type:"image",image:u,mimeType:o,providerMetadata:(s=e.providerOptions)!=null?s:e.experimental_providerMetadata};case"file":{if(o==null)throw new Error("Mime type is missing for file part");return{type:"file",data:u instanceof Uint8Array?Or(u):u,filename:e.filename,mimeType:o,providerMetadata:(n=e.providerOptions)!=null?n:e.experimental_providerMetadata}}}}function wt({maxTokens:e,temperature:t,topP:r,topK:a,presencePenalty:s,frequencyPenalty:n,stopSequences:o,seed:l}){if(e!=null){if(!Number.isInteger(e))throw new R({parameter:"maxTokens",value:e,message:"maxTokens must be an integer"});if(e<1)throw new R({parameter:"maxTokens",value:e,message:"maxTokens must be >= 1"})}if(t!=null&&typeof t!="number")throw new R({parameter:"temperature",value:t,message:"temperature must be a number"});if(r!=null&&typeof r!="number")throw new R({parameter:"topP",value:r,message:"topP must be a number"});if(a!=null&&typeof a!="number")throw new R({parameter:"topK",value:a,message:"topK must be a number"});if(s!=null&&typeof s!="number")throw new R({parameter:"presencePenalty",value:s,message:"presencePenalty must be a number"});if(n!=null&&typeof n!="number")throw new R({parameter:"frequencyPenalty",value:n,message:"frequencyPenalty must be a number"});if(l!=null&&!Number.isInteger(l))throw new R({parameter:"seed",value:l,message:"seed must be an integer"});return{maxTokens:e,temperature:t??0,topP:r,topK:a,presencePenalty:s,frequencyPenalty:n,stopSequences:o!=null&&o.length>0?o:void 0,seed:l}}function tr(e){var t,r,a;const s=[];for(const n of e){let o;try{o=new URL(n.url)}catch{throw new Error(`Invalid URL: ${n.url}`)}switch(o.protocol){case"http:":case"https:":{if((t=n.contentType)!=null&&t.startsWith("image/"))s.push({type:"image",image:o});else{if(!n.contentType)throw new Error("If the attachment is not an image, it must specify a content type");s.push({type:"file",data:o,mimeType:n.contentType})}break}case"data:":{let l,c,u;try{[l,c]=n.url.split(","),u=l.split(";")[0].split(":")[1]}catch{throw new Error(`Error processing data URL: ${n.url}`)}if(u==null||c==null)throw new Error(`Invalid data URL format: ${n.url}`);if((r=n.contentType)!=null&&r.startsWith("image/"))s.push({type:"image",image:et(c)});else if((a=n.contentType)!=null&&a.startsWith("text/"))s.push({type:"text",text:Sn(et(c))});else{if(!n.contentType)throw new Error("If the attachment is not an image or text, it must specify a content type");s.push({type:"file",data:c,mimeType:n.contentType})}break}default:throw new Error(`Unsupported URL protocol: ${o.protocol}`)}}return s}var Ur="AI_MessageConversionError",$r=`vercel.ai.error.${Ur}`,En=Symbol.for($r),Fr,dt=class extends I{constructor({originalMessage:e,message:t}){super({name:Ur,message:t}),this[Fr]=!0,this.originalMessage=e}static isInstance(e){return I.hasMarker(e,$r)}};Fr=En;function An(e,t){var r,a;const s=(r=t?.tools)!=null?r:{},n=[];for(let o=0;o<e.length;o++){const l=e[o],c=o===e.length-1,{role:u,content:d,experimental_attachments:m}=l;switch(u){case"system":{n.push({role:"system",content:d});break}case"user":{if(l.parts==null)n.push({role:"user",content:m?[{type:"text",text:d},...tr(m)]:d});else{const v=l.parts.filter(b=>b.type==="text").map(b=>({type:"text",text:b.text}));n.push({role:"user",content:m?[...v,...tr(m)]:v})}break}case"assistant":{if(l.parts!=null){let x=function(){const y=[];for(const h of f)switch(h.type){case"file":case"text":{y.push(h);break}case"reasoning":{for(const P of h.details)switch(P.type){case"text":y.push({type:"reasoning",text:P.text,signature:P.signature});break;case"redacted":y.push({type:"redacted-reasoning",data:P.data});break}break}case"tool-invocation":y.push({type:"tool-call",toolCallId:h.toolInvocation.toolCallId,toolName:h.toolInvocation.toolName,args:h.toolInvocation.args});break;default:{const P=h;throw new Error(`Unsupported part: ${P}`)}}n.push({role:"assistant",content:y});const N=f.filter(h=>h.type==="tool-invocation").map(h=>h.toolInvocation);N.length>0&&n.push({role:"tool",content:N.map(h=>{if(!("result"in h))throw new dt({originalMessage:l,message:"ToolInvocation must have a result: "+JSON.stringify(h)});const{toolCallId:P,toolName:k,result:D}=h,O=s[k];return O?.experimental_toToolResultContent!=null?{type:"tool-result",toolCallId:P,toolName:k,result:O.experimental_toToolResultContent(D),experimental_content:O.experimental_toToolResultContent(D)}:{type:"tool-result",toolCallId:P,toolName:k,result:D}})}),f=[],w=!1,C++},C=0,w=!1,f=[];for(const y of l.parts)switch(y.type){case"text":{w&&x(),f.push(y);break}case"file":case"reasoning":{f.push(y);break}case"tool-invocation":{((a=y.toolInvocation.step)!=null?a:0)!==C&&x(),f.push(y),w=!0;break}}x();break}const v=l.toolInvocations;if(v==null||v.length===0){n.push({role:"assistant",content:d});break}const b=v.reduce((x,C)=>{var w;return Math.max(x,(w=C.step)!=null?w:0)},0);for(let x=0;x<=b;x++){const C=v.filter(w=>{var f;return((f=w.step)!=null?f:0)===x});C.length!==0&&(n.push({role:"assistant",content:[...c&&d&&x===0?[{type:"text",text:d}]:[],...C.map(({toolCallId:w,toolName:f,args:y})=>({type:"tool-call",toolCallId:w,toolName:f,args:y}))]}),n.push({role:"tool",content:C.map(w=>{if(!("result"in w))throw new dt({originalMessage:l,message:"ToolInvocation must have a result: "+JSON.stringify(w)});const{toolCallId:f,toolName:y,result:N}=w,h=s[y];return h?.experimental_toToolResultContent!=null?{type:"tool-result",toolCallId:f,toolName:y,result:h.experimental_toToolResultContent(N),experimental_content:h.experimental_toToolResultContent(N)}:{type:"tool-result",toolCallId:f,toolName:y,result:N}})}))}d&&!c&&n.push({role:"assistant",content:d});break}case"data":break;default:{const v=u;throw new dt({originalMessage:l,message:`Unsupported role: ${v}`})}}}return n}function jn(e){if(!Array.isArray(e))return"other";if(e.length===0)return"messages";const t=e.map(Mn);return t.some(r=>r==="has-ui-specific-parts")?"ui-messages":t.every(r=>r==="has-core-specific-parts"||r==="message")?"messages":"other"}function Mn(e){return typeof e=="object"&&e!==null&&(e.role==="function"||e.role==="data"||"toolInvocations"in e||"parts"in e||"experimental_attachments"in e)?"has-ui-specific-parts":typeof e=="object"&&e!==null&&"content"in e&&(Array.isArray(e.content)||"experimental_providerMetadata"in e||"providerOptions"in e)?"has-core-specific-parts":typeof e=="object"&&e!==null&&"role"in e&&"content"in e&&typeof e.content=="string"&&["system","user","assistant","tool"].includes(e.role)?"message":"other"}var bt=i.lazy(()=>i.union([i.null(),i.string(),i.number(),i.boolean(),i.record(i.string(),bt),i.array(bt)])),A=i.record(i.string(),i.record(i.string(),bt)),Nn=i.array(i.union([i.object({type:i.literal("text"),text:i.string()}),i.object({type:i.literal("image"),data:i.string(),mimeType:i.string().optional()})])),Jr=i.object({type:i.literal("text"),text:i.string(),providerOptions:A.optional(),experimental_providerMetadata:A.optional()}),On=i.object({type:i.literal("image"),image:i.union([Nr,i.instanceof(URL)]),mimeType:i.string().optional(),providerOptions:A.optional(),experimental_providerMetadata:A.optional()}),Br=i.object({type:i.literal("file"),data:i.union([Nr,i.instanceof(URL)]),filename:i.string().optional(),mimeType:i.string(),providerOptions:A.optional(),experimental_providerMetadata:A.optional()}),kn=i.object({type:i.literal("reasoning"),text:i.string(),providerOptions:A.optional(),experimental_providerMetadata:A.optional()}),Dn=i.object({type:i.literal("redacted-reasoning"),data:i.string(),providerOptions:A.optional(),experimental_providerMetadata:A.optional()}),qn=i.object({type:i.literal("tool-call"),toolCallId:i.string(),toolName:i.string(),args:i.unknown(),providerOptions:A.optional(),experimental_providerMetadata:A.optional()}),Un=i.object({type:i.literal("tool-result"),toolCallId:i.string(),toolName:i.string(),result:i.unknown(),content:Nn.optional(),isError:i.boolean().optional(),providerOptions:A.optional(),experimental_providerMetadata:A.optional()}),$n=i.object({role:i.literal("system"),content:i.string(),providerOptions:A.optional(),experimental_providerMetadata:A.optional()}),Fn=i.object({role:i.literal("user"),content:i.union([i.string(),i.array(i.union([Jr,On,Br]))]),providerOptions:A.optional(),experimental_providerMetadata:A.optional()}),Jn=i.object({role:i.literal("assistant"),content:i.union([i.string(),i.array(i.union([Jr,Br,kn,Dn,qn]))]),providerOptions:A.optional(),experimental_providerMetadata:A.optional()}),Bn=i.object({role:i.literal("tool"),content:i.array(Un),providerOptions:A.optional(),experimental_providerMetadata:A.optional()}),Gn=i.union([$n,Fn,Jn,Bn]);function xt({prompt:e,tools:t}){if(e.prompt==null&&e.messages==null)throw new ve({prompt:e,message:"prompt or messages must be defined"});if(e.prompt!=null&&e.messages!=null)throw new ve({prompt:e,message:"prompt and messages cannot be defined at the same time"});if(e.system!=null&&typeof e.system!="string")throw new ve({prompt:e,message:"system must be a string"});if(e.prompt!=null){if(typeof e.prompt!="string")throw new ve({prompt:e,message:"prompt must be a string"});return{type:"prompt",system:e.system,messages:[{role:"user",content:e.prompt}]}}if(e.messages!=null){const r=jn(e.messages);if(r==="other")throw new ve({prompt:e,message:"messages must be an array of CoreMessage or UIMessage"});const a=r==="ui-messages"?An(e.messages,{tools:t}):e.messages;if(a.length===0)throw new ve({prompt:e,message:"messages must not be empty"});const s=Re({value:a,schema:i.array(Gn)});if(!s.success)throw new ve({prompt:e,message:"messages must be an array of CoreMessage or UIMessage",cause:s.error});return{type:"messages",messages:a,system:e.system}}throw new Error("unreachable")}function Gr({promptTokens:e,completionTokens:t}){return{promptTokens:e,completionTokens:t,totalTokens:e+t}}function Ln(e,t){return{promptTokens:e.promptTokens+t.promptTokens,completionTokens:e.completionTokens+t.completionTokens,totalTokens:e.totalTokens+t.totalTokens}}var Wn="JSON schema:",Vn="You MUST answer with a JSON object that matches the JSON schema above.",zn="You MUST answer with JSON.";function St({prompt:e,schema:t,schemaPrefix:r=t!=null?Wn:void 0,schemaSuffix:a=t!=null?Vn:zn}){return[e!=null&&e.length>0?e:void 0,e!=null&&e.length>0?"":void 0,r,t!=null?JSON.stringify(t):void 0,a].filter(s=>s!=null).join(`
`)}function we(e){const t=e.pipeThrough(new TransformStream);return t[Symbol.asyncIterator]=()=>{const r=t.getReader();return{async next(){const{done:a,value:s}=await r.read();return a?{done:!0,value:void 0}:{done:!1,value:s}}}},t}var Xn={type:"no-schema",jsonSchema:void 0,validatePartialResult({value:e,textDelta:t}){return{success:!0,value:{partial:e,textDelta:t}}},validateFinalResult(e,t){return e===void 0?{success:!1,error:new Ze({message:"No object generated: response did not match schema.",text:t.text,response:t.response,usage:t.usage,finishReason:t.finishReason})}:{success:!0,value:e}},createElementStream(){throw new He({functionality:"element streams in no-schema mode"})}},Hn=e=>({type:"object",jsonSchema:e.jsonSchema,validatePartialResult({value:t,textDelta:r}){return{success:!0,value:{partial:t,textDelta:r}}},validateFinalResult(t){return Re({value:t,schema:e})},createElementStream(){throw new He({functionality:"element streams in object mode"})}}),Kn=e=>{const{$schema:t,...r}=e.jsonSchema;return{type:"enum",jsonSchema:{$schema:"http://json-schema.org/draft-07/schema#",type:"object",properties:{elements:{type:"array",items:r}},required:["elements"],additionalProperties:!1},validatePartialResult({value:a,latestObject:s,isFirstDelta:n,isFinalDelta:o}){var l;if(!mt(a)||!Ht(a.elements))return{success:!1,error:new Ke({value:a,cause:"value must be an object that contains an array of elements"})};const c=a.elements,u=[];for(let v=0;v<c.length;v++){const b=c[v],x=Re({value:b,schema:e});if(!(v===c.length-1&&!o)){if(!x.success)return x;u.push(x.value)}}const d=(l=s?.length)!=null?l:0;let m="";return n&&(m+="["),d>0&&(m+=","),m+=u.slice(d).map(v=>JSON.stringify(v)).join(","),o&&(m+="]"),{success:!0,value:{partial:u,textDelta:m}}},validateFinalResult(a){if(!mt(a)||!Ht(a.elements))return{success:!1,error:new Ke({value:a,cause:"value must be an object that contains an array of elements"})};const s=a.elements;for(const n of s){const o=Re({value:n,schema:e});if(!o.success)return o}return{success:!0,value:s}},createElementStream(a){let s=0;return we(a.pipeThrough(new TransformStream({transform(n,o){switch(n.type){case"object":{const l=n.object;for(;s<l.length;s++)o.enqueue(l[s]);break}case"text-delta":case"finish":case"error":break;default:{const l=n;throw new Error(`Unsupported chunk type: ${l}`)}}}})))}}},Yn=e=>({type:"enum",jsonSchema:{$schema:"http://json-schema.org/draft-07/schema#",type:"object",properties:{result:{type:"string",enum:e}},required:["result"],additionalProperties:!1},validateFinalResult(t){if(!mt(t)||typeof t.result!="string")return{success:!1,error:new Ke({value:t,cause:'value must be an object that contains a string in the "result" property.'})};const r=t.result;return e.includes(r)?{success:!0,value:r}:{success:!1,error:new Ke({value:t,cause:"value must be a string in the enum"})}},validatePartialResult(){throw new He({functionality:"partial results in enum mode"})},createElementStream(){throw new He({functionality:"element streams in enum mode"})}});function Qn({output:e,schema:t,enumValues:r}){switch(e){case"object":return Hn(Ie(t));case"array":return Kn(Ie(t));case"enum":return Yn(r);case"no-schema":return Xn;default:{const a=e;throw new Error(`Unsupported output: ${a}`)}}}function Zn({output:e,mode:t,schema:r,schemaName:a,schemaDescription:s,enumValues:n}){if(e!=null&&e!=="object"&&e!=="array"&&e!=="enum"&&e!=="no-schema")throw new R({parameter:"output",value:e,message:"Invalid output type."});if(e==="no-schema"){if(t==="auto"||t==="tool")throw new R({parameter:"mode",value:t,message:'Mode must be "json" for no-schema output.'});if(r!=null)throw new R({parameter:"schema",value:r,message:"Schema is not supported for no-schema output."});if(s!=null)throw new R({parameter:"schemaDescription",value:s,message:"Schema description is not supported for no-schema output."});if(a!=null)throw new R({parameter:"schemaName",value:a,message:"Schema name is not supported for no-schema output."});if(n!=null)throw new R({parameter:"enumValues",value:n,message:"Enum values are not supported for no-schema output."})}if(e==="object"){if(r==null)throw new R({parameter:"schema",value:r,message:"Schema is required for object output."});if(n!=null)throw new R({parameter:"enumValues",value:n,message:"Enum values are not supported for object output."})}if(e==="array"){if(r==null)throw new R({parameter:"schema",value:r,message:"Element schema is required for array output."});if(n!=null)throw new R({parameter:"enumValues",value:n,message:"Enum values are not supported for array output."})}if(e==="enum"){if(r!=null)throw new R({parameter:"schema",value:r,message:"Schema is not supported for enum output."});if(s!=null)throw new R({parameter:"schemaDescription",value:s,message:"Schema description is not supported for enum output."});if(a!=null)throw new R({parameter:"schemaName",value:a,message:"Schema name is not supported for enum output."});if(n==null)throw new R({parameter:"enumValues",value:n,message:"Enum values are required for enum output."});for(const o of n)if(typeof o!="string")throw new R({parameter:"enumValues",value:o,message:"Enum values must be strings."})}}Pe({prefix:"aiobj",size:24});var M=class{constructor(){this.status={type:"pending"},this._resolve=void 0,this._reject=void 0}get value(){return this.promise?this.promise:(this.promise=new Promise((e,t)=>{this.status.type==="resolved"?e(this.status.value):this.status.type==="rejected"&&t(this.status.error),this._resolve=e,this._reject=t}),this.promise)}resolve(e){var t;this.status={type:"resolved",value:e},this.promise&&((t=this._resolve)==null||t.call(this,e))}reject(e){var t;this.status={type:"rejected",error:e},this.promise&&((t=this._reject)==null||t.call(this,e))}};function rr(){let e,t;return{promise:new Promise((a,s)=>{e=a,t=s}),resolve:e,reject:t}}function Lr(){let e=[],t=null,r=!1,a=rr();const s=async()=>{if(r&&e.length===0){t?.close();return}if(e.length===0)return a=rr(),await a.promise,s();try{const{value:n,done:o}=await e[0].read();o?(e.shift(),e.length>0?await s():r&&t?.close()):t?.enqueue(n)}catch(n){t?.error(n),e.shift(),r&&e.length===0&&t?.close()}};return{stream:new ReadableStream({start(n){t=n},pull:s,async cancel(){for(const n of e)await n.cancel();e=[],r=!0}}),addStream:n=>{if(r)throw new Error("Cannot add inner stream: outer stream is closed");e.push(n.getReader()),a.resolve()},close:()=>{r=!0,a.resolve(),e.length===0&&t?.close()},terminate:()=>{r=!0,a.resolve(),e.forEach(n=>n.cancel()),e=[],t?.close()}}}function Wr(){var e,t;return(t=(e=globalThis?.performance)==null?void 0:e.now())!=null?t:Date.now()}var es=Pe({prefix:"aiobj",size:24});function eo({model:e,schema:t,schemaName:r,schemaDescription:a,mode:s,output:n="object",system:o,prompt:l,messages:c,maxRetries:u,abortSignal:d,headers:m,experimental_telemetry:v,experimental_providerMetadata:b,providerOptions:x=b,onError:C,onFinish:w,_internal:{generateId:f=es,currentDate:y=()=>new Date,now:N=Wr}={},...h}){Zn({output:n,mode:s,schema:t,schemaName:r,schemaDescription:a});const P=Qn({output:n,schema:t});return P.type==="no-schema"&&s===void 0&&(s="json"),new ts({model:e,telemetry:v,headers:m,settings:h,maxRetries:u,abortSignal:d,outputStrategy:P,system:o,prompt:l,messages:c,schemaName:r,schemaDescription:a,providerOptions:x,mode:s,onError:C,onFinish:w,generateId:f,currentDate:y,now:N})}var ts=class{constructor({model:e,headers:t,telemetry:r,settings:a,maxRetries:s,abortSignal:n,outputStrategy:o,system:l,prompt:c,messages:u,schemaName:d,schemaDescription:m,providerOptions:v,mode:b,onError:x,onFinish:C,generateId:w,currentDate:f,now:y}){this.objectPromise=new M,this.usagePromise=new M,this.providerMetadataPromise=new M,this.warningsPromise=new M,this.requestPromise=new M,this.responsePromise=new M;const{maxRetries:N,retry:h}=xr({maxRetries:s}),P=Sr({model:e,telemetry:r,headers:t,settings:{...a,maxRetries:N}}),k=Tr(r),D=this,O=Lr(),pe=new TransformStream({transform(F,V){V.enqueue(F),F.type==="error"&&x?.({error:F.error})}});this.baseStream=O.stream.pipeThrough(pe),$e({name:"ai.streamObject",attributes:Z({telemetry:r,attributes:{...Ue({operationId:"ai.streamObject",telemetry:r}),...P,"ai.prompt":{input:()=>JSON.stringify({system:l,prompt:c,messages:u})},"ai.schema":o.jsonSchema!=null?{input:()=>JSON.stringify(o.jsonSchema)}:void 0,"ai.schema.name":d,"ai.schema.description":m,"ai.settings.output":o.type,"ai.settings.mode":b}}),tracer:k,endWhenDone:!1,fn:async F=>{var V,ae;(b==="auto"||b==null)&&(b=e.defaultObjectGenerationMode);let ee,ne;switch(b){case"json":{const S=xt({prompt:{system:o.jsonSchema==null?St({prompt:l}):e.supportsStructuredOutputs?l:St({prompt:l,schema:o.jsonSchema}),prompt:c,messages:u},tools:void 0});ee={mode:{type:"object-json",schema:o.jsonSchema,name:d,description:m},...wt(a),inputFormat:S.type,prompt:await yt({prompt:S,modelSupportsImageUrls:e.supportsImageUrls,modelSupportsUrl:(V=e.supportsUrl)==null?void 0:V.bind(e)}),providerMetadata:v,abortSignal:n,headers:t},ne={transform:(T,_)=>{switch(T.type){case"text-delta":_.enqueue(T.textDelta);break;case"response-metadata":case"finish":case"error":_.enqueue(T);break}}};break}case"tool":{const S=xt({prompt:{system:l,prompt:c,messages:u},tools:void 0});ee={mode:{type:"object-tool",tool:{type:"function",name:d??"json",description:m??"Respond with a JSON object.",parameters:o.jsonSchema}},...wt(a),inputFormat:S.type,prompt:await yt({prompt:S,modelSupportsImageUrls:e.supportsImageUrls,modelSupportsUrl:(ae=e.supportsUrl)==null?void 0:ae.bind(e)}),providerMetadata:v,abortSignal:n,headers:t},ne={transform(T,_){switch(T.type){case"tool-call-delta":_.enqueue(T.argsTextDelta);break;case"response-metadata":case"finish":case"error":_.enqueue(T);break}}};break}case void 0:throw new Error("Model does not have a default object generation mode.");default:{const S=b;throw new Error(`Unsupported mode: ${S}`)}}const{result:{stream:se,warnings:be,rawResponse:J,request:xe},doStreamSpan:de,startTimestampMs:oe}=await h(()=>$e({name:"ai.streamObject.doStream",attributes:Z({telemetry:r,attributes:{...Ue({operationId:"ai.streamObject.doStream",telemetry:r}),...P,"ai.prompt.format":{input:()=>ee.inputFormat},"ai.prompt.messages":{input:()=>JSON.stringify(ee.prompt)},"ai.settings.mode":b,"gen_ai.system":e.provider,"gen_ai.request.model":e.modelId,"gen_ai.request.frequency_penalty":a.frequencyPenalty,"gen_ai.request.max_tokens":a.maxTokens,"gen_ai.request.presence_penalty":a.presencePenalty,"gen_ai.request.temperature":a.temperature,"gen_ai.request.top_k":a.topK,"gen_ai.request.top_p":a.topP}}),tracer:k,endWhenDone:!1,fn:async S=>({startTimestampMs:y(),doStreamSpan:S,result:await e.doStream(ee)})}));D.requestPromise.resolve(xe??{});let U,K,ie,te,Se,z="",re="",q={id:w(),timestamp:f(),modelId:e.modelId},le,ue,Je=!0,Be=!0;const Ee=se.pipeThrough(new TransformStream(ne)).pipeThrough(new TransformStream({async transform(S,T){var _,B,G;if(Je){const p=y()-oe;Je=!1,de.addEvent("ai.stream.firstChunk",{"ai.stream.msToFirstChunk":p}),de.setAttributes({"ai.stream.msToFirstChunk":p})}if(typeof S=="string"){z+=S,re+=S;const{value:p,state:$}=or(z);if(p!==void 0&&!Kt(le,p)){const L=o.validatePartialResult({value:p,textDelta:re,latestObject:ue,isFirstDelta:Be,isFinalDelta:$==="successful-parse"});L.success&&!Kt(ue,L.value.partial)&&(le=p,ue=L.value.partial,T.enqueue({type:"object",object:ue}),T.enqueue({type:"text-delta",textDelta:L.value.textDelta}),re="",Be=!1)}return}switch(S.type){case"response-metadata":{q={id:(_=S.id)!=null?_:q.id,timestamp:(B=S.timestamp)!=null?B:q.timestamp,modelId:(G=S.modelId)!=null?G:q.modelId};break}case"finish":{re!==""&&T.enqueue({type:"text-delta",textDelta:re}),K=S.finishReason,U=Gr(S.usage),ie=S.providerMetadata,T.enqueue({...S,usage:U,response:q}),D.usagePromise.resolve(U),D.providerMetadataPromise.resolve(ie),D.responsePromise.resolve({...q,headers:J?.headers});const p=o.validateFinalResult(le,{text:z,response:q,usage:U});p.success?(te=p.value,D.objectPromise.resolve(te)):(Se=new Ze({message:"No object generated: response did not match schema.",cause:p.error,text:z,response:q,usage:U,finishReason:K}),D.objectPromise.reject(Se));break}default:{T.enqueue(S);break}}},async flush(S){try{const T=U??{promptTokens:NaN,completionTokens:NaN,totalTokens:NaN};de.setAttributes(Z({telemetry:r,attributes:{"ai.response.finishReason":K,"ai.response.object":{output:()=>JSON.stringify(te)},"ai.response.id":q.id,"ai.response.model":q.modelId,"ai.response.timestamp":q.timestamp.toISOString(),"ai.usage.promptTokens":T.promptTokens,"ai.usage.completionTokens":T.completionTokens,"gen_ai.response.finish_reasons":[K],"gen_ai.response.id":q.id,"gen_ai.response.model":q.modelId,"gen_ai.usage.input_tokens":T.promptTokens,"gen_ai.usage.output_tokens":T.completionTokens}})),de.end(),F.setAttributes(Z({telemetry:r,attributes:{"ai.usage.promptTokens":T.promptTokens,"ai.usage.completionTokens":T.completionTokens,"ai.response.object":{output:()=>JSON.stringify(te)}}})),await C?.({usage:T,object:te,error:Se,response:{...q,headers:J?.headers},warnings:be,providerMetadata:ie,experimental_providerMetadata:ie})}catch(T){S.enqueue({type:"error",error:T})}finally{F.end()}}}));O.addStream(Ee)}}).catch(F=>{O.addStream(new ReadableStream({start(V){V.enqueue({type:"error",error:F}),V.close()}}))}).finally(()=>{O.close()}),this.outputStrategy=o}get object(){return this.objectPromise.value}get usage(){return this.usagePromise.value}get experimental_providerMetadata(){return this.providerMetadataPromise.value}get providerMetadata(){return this.providerMetadataPromise.value}get warnings(){return this.warningsPromise.value}get request(){return this.requestPromise.value}get response(){return this.responsePromise.value}get partialObjectStream(){return we(this.baseStream.pipeThrough(new TransformStream({transform(e,t){switch(e.type){case"object":t.enqueue(e.object);break;case"text-delta":case"finish":case"error":break;default:{const r=e;throw new Error(`Unsupported chunk type: ${r}`)}}}})))}get elementStream(){return this.outputStrategy.createElementStream(this.baseStream)}get textStream(){return we(this.baseStream.pipeThrough(new TransformStream({transform(e,t){switch(e.type){case"text-delta":t.enqueue(e.textDelta);break;case"object":case"finish":case"error":break;default:{const r=e;throw new Error(`Unsupported chunk type: ${r}`)}}}})))}get fullStream(){return we(this.baseStream)}pipeTextStreamToResponse(e,t){vt({response:e,status:t?.status,statusText:t?.statusText,headers:gt(t?.headers,{contentType:"text/plain; charset=utf-8"}),stream:this.textStream.pipeThrough(new TextEncoderStream)})}toTextStreamResponse(e){var t;return new Response(this.textStream.pipeThrough(new TextEncoderStream),{status:(t=e?.status)!=null?t:200,headers:Ce(e?.headers,{contentType:"text/plain; charset=utf-8"})})}},Vr="AI_NoOutputSpecifiedError",zr=`vercel.ai.error.${Vr}`,rs=Symbol.for(zr),Xr,as=class extends I{constructor({message:e="No output specified."}={}){super({name:Vr,message:e}),this[Xr]=!0}static isInstance(e){return I.hasMarker(e,zr)}};Xr=rs;var Hr="AI_ToolExecutionError",Kr=`vercel.ai.error.${Hr}`,ns=Symbol.for(Kr),Yr,ss=class extends I{constructor({toolArgs:e,toolName:t,toolCallId:r,cause:a,message:s=`Error executing tool ${t}: ${It(a)}`}){super({name:Hr,message:s,cause:a}),this[Yr]=!0,this.toolArgs=e,this.toolName=t,this.toolCallId=r}static isInstance(e){return I.hasMarker(e,Kr)}};Yr=ns;function os(e){return e!=null&&Object.keys(e).length>0}function is({tools:e,toolChoice:t,activeTools:r}){return os(e)?{tools:(r!=null?Object.entries(e).filter(([s])=>r.includes(s)):Object.entries(e)).map(([s,n])=>{const o=n.type;switch(o){case void 0:case"function":return{type:"function",name:s,description:n.description,parameters:Ie(n.parameters).jsonSchema};case"provider-defined":return{type:"provider-defined",name:s,id:n.id,args:n.args};default:{const l=o;throw new Error(`Unsupported tool type: ${l}`)}}}),toolChoice:t==null?{type:"auto"}:typeof t=="string"?{type:t}:{type:"tool",toolName:t.toolName}}:{tools:void 0,toolChoice:void 0}}var ls=/^([\s\S]*?)(\s+)(\S*)$/;function us(e){const t=e.match(ls);return t?{prefix:t[1],whitespace:t[2],suffix:t[3]}:void 0}var Qr="AI_InvalidToolArgumentsError",Zr=`vercel.ai.error.${Qr}`,cs=Symbol.for(Zr),ea,ta=class extends I{constructor({toolArgs:e,toolName:t,cause:r,message:a=`Invalid arguments for tool ${t}: ${It(r)}`}){super({name:Qr,message:a,cause:r}),this[ea]=!0,this.toolArgs=e,this.toolName=t}static isInstance(e){return I.hasMarker(e,Zr)}};ea=cs;var ra="AI_NoSuchToolError",aa=`vercel.ai.error.${ra}`,ps=Symbol.for(aa),na,Tt=class extends I{constructor({toolName:e,availableTools:t=void 0,message:r=`Model tried to call unavailable tool '${e}'. ${t===void 0?"No tools are available.":`Available tools: ${t.join(", ")}.`}`}){super({name:ra,message:r}),this[na]=!0,this.toolName=e,this.availableTools=t}static isInstance(e){return I.hasMarker(e,aa)}};na=ps;var sa="AI_ToolCallRepairError",oa=`vercel.ai.error.${sa}`,ds=Symbol.for(oa),ia,ms=class extends I{constructor({cause:e,originalError:t,message:r=`Error repairing tool call: ${It(e)}`}){super({name:sa,message:r,cause:e}),this[ia]=!0,this.originalError=t}static isInstance(e){return I.hasMarker(e,oa)}};ia=ds;async function fs({toolCall:e,tools:t,repairToolCall:r,system:a,messages:s}){if(t==null)throw new Tt({toolName:e.toolName});try{return await ar({toolCall:e,tools:t})}catch(n){if(r==null||!(Tt.isInstance(n)||ta.isInstance(n)))throw n;let o=null;try{o=await r({toolCall:e,tools:t,parameterSchema:({toolName:l})=>Ie(t[l].parameters).jsonSchema,system:a,messages:s,error:n})}catch(l){throw new ms({cause:l,originalError:n})}if(o==null)throw n;return await ar({toolCall:o,tools:t})}}async function ar({toolCall:e,tools:t}){const r=e.toolName,a=t[r];if(a==null)throw new Tt({toolName:e.toolName,availableTools:Object.keys(t)});const s=Ie(a.parameters),n=e.args.trim()===""?Re({value:{},schema:s}):ir({text:e.args,schema:s});if(n.success===!1)throw new ta({toolName:r,toolArgs:e.args,cause:n.error});return{type:"tool-call",toolCallId:e.toolCallId,toolName:r,args:n.value}}function hs(e){const t=e.filter(r=>r.type==="text").map(r=>r.text).join("");return t.length>0?t:void 0}function nr({text:e="",files:t,reasoning:r,tools:a,toolCalls:s,toolResults:n,messageId:o,generateMessageId:l}){const c=[],u=[];return r.length>0&&u.push(...r.map(d=>d.type==="text"?{...d,type:"reasoning"}:{...d,type:"redacted-reasoning"})),t.length>0&&u.push(...t.map(d=>({type:"file",data:d.base64,mimeType:d.mimeType}))),e.length>0&&u.push({type:"text",text:e}),s.length>0&&u.push(...s),u.length>0&&c.push({role:"assistant",content:u,id:o}),n.length>0&&c.push({role:"tool",id:l(),content:n.map(d=>{const m=a[d.toolName];return m?.experimental_toToolResultContent!=null?{type:"tool-result",toolCallId:d.toolCallId,toolName:d.toolName,result:m.experimental_toToolResultContent(d.result),experimental_content:m.experimental_toToolResultContent(d.result)}:{type:"tool-result",toolCallId:d.toolCallId,toolName:d.toolName,result:d.result}})}),c}Pe({prefix:"aitxt",size:24});Pe({prefix:"msg",size:24});var gs={};jt(gs,{object:()=>bs,text:()=>ws});var la="AI_InvalidStreamPartError",ua=`vercel.ai.error.${la}`,vs=Symbol.for(ua),ca,ys=class extends I{constructor({chunk:e,message:t}){super({name:la,message:t}),this[ca]=!0,this.chunk=e}static isInstance(e){return I.hasMarker(e,ua)}};ca=vs;var ws=()=>({type:"text",responseFormat:()=>({type:"text"}),injectIntoSystemPrompt({system:e}){return e},parsePartial({text:e}){return{partial:e}},parseOutput({text:e}){return e}}),bs=({schema:e})=>{const t=Ie(e);return{type:"object",responseFormat:({model:r})=>({type:"json",schema:r.supportsStructuredOutputs?t.jsonSchema:void 0}),injectIntoSystemPrompt({system:r,model:a}){return a.supportsStructuredOutputs?r:St({prompt:r,schema:t.jsonSchema})},parsePartial({text:r}){const a=or(r);switch(a.state){case"failed-parse":case"undefined-input":return;case"repaired-parse":case"successful-parse":return{partial:a.value};default:{const s=a.state;throw new Error(`Unsupported parse state: ${s}`)}}},parseOutput({text:r},a){const s=ir({text:r});if(!s.success)throw new Ze({message:"No object generated: could not parse the response.",cause:s.error,text:r,response:a.response,usage:a.usage,finishReason:a.finishReason});const n=Re({value:s.value,schema:t});if(!n.success)throw new Ze({message:"No object generated: response did not match schema.",cause:n.error,text:r,response:a.response,usage:a.usage,finishReason:a.finishReason});return n.value}}};function xs(e){return e===void 0?[]:Array.isArray(e)?e:[e]}async function Ss({stream:e,onError:t}){const r=e.getReader();try{for(;;){const{done:a}=await r.read();if(a)break}}catch(a){t?.(a)}finally{r.releaseLock()}}function Mt(e,t){const r=e.getReader(),a=t.getReader();let s,n,o=!1,l=!1;async function c(d){try{s==null&&(s=r.read());const m=await s;s=void 0,m.done?d.close():d.enqueue(m.value)}catch(m){d.error(m)}}async function u(d){try{n==null&&(n=a.read());const m=await n;n=void 0,m.done?d.close():d.enqueue(m.value)}catch(m){d.error(m)}}return new ReadableStream({async pull(d){try{if(o){await u(d);return}if(l){await c(d);return}s==null&&(s=r.read()),n==null&&(n=a.read());const{result:m,reader:v}=await Promise.race([s.then(b=>({result:b,reader:r})),n.then(b=>({result:b,reader:a}))]);m.done||d.enqueue(m.value),v===r?(s=void 0,m.done&&(await u(d),o=!0)):(n=void 0,m.done&&(l=!0,await c(d)))}catch(m){d.error(m)}},cancel(){r.cancel(),a.cancel()}})}function Ts({tools:e,generatorStream:t,toolCallStreaming:r,tracer:a,telemetry:s,system:n,messages:o,abortSignal:l,repairToolCall:c}){let u=null;const d=new ReadableStream({start(f){u=f}}),m={},v=new Set;let b=!1,x;function C(){b&&v.size===0&&(x!=null&&u.enqueue(x),u.close())}const w=new TransformStream({async transform(f,y){const N=f.type;switch(N){case"text-delta":case"reasoning":case"reasoning-signature":case"redacted-reasoning":case"source":case"response-metadata":case"error":{y.enqueue(f);break}case"file":{y.enqueue(new mn({data:f.data,mimeType:f.mimeType}));break}case"tool-call-delta":{r&&(m[f.toolCallId]||(y.enqueue({type:"tool-call-streaming-start",toolCallId:f.toolCallId,toolName:f.toolName}),m[f.toolCallId]=!0),y.enqueue({type:"tool-call-delta",toolCallId:f.toolCallId,toolName:f.toolName,argsTextDelta:f.argsTextDelta}));break}case"tool-call":{try{const h=await fs({toolCall:f,tools:e,repairToolCall:c,system:n,messages:o});y.enqueue(h);const P=e[h.toolName];if(P.execute!=null){const k=ba();v.add(k),$e({name:"ai.toolCall",attributes:Z({telemetry:s,attributes:{...Ue({operationId:"ai.toolCall",telemetry:s}),"ai.toolCall.name":h.toolName,"ai.toolCall.id":h.toolCallId,"ai.toolCall.args":{output:()=>JSON.stringify(h.args)}}}),tracer:a,fn:async D=>P.execute(h.args,{toolCallId:h.toolCallId,messages:o,abortSignal:l}).then(O=>{u.enqueue({...h,type:"tool-result",result:O}),v.delete(k),C();try{D.setAttributes(Z({telemetry:s,attributes:{"ai.toolCall.result":{output:()=>JSON.stringify(O)}}}))}catch{}},O=>{u.enqueue({type:"error",error:new ss({toolCallId:h.toolCallId,toolName:h.toolName,toolArgs:h.args,cause:O})}),v.delete(k),C()})})}}catch(h){u.enqueue({type:"error",error:h})}break}case"finish":{x={type:"finish",finishReason:f.finishReason,logprobs:f.logprobs,usage:Gr(f.usage),experimental_providerMetadata:f.providerMetadata};break}default:{const h=N;throw new Error(`Unhandled chunk type: ${h}`)}}},flush(){b=!0,C()}});return new ReadableStream({async start(f){return Promise.all([t.pipeThrough(w).pipeTo(new WritableStream({write(y){f.enqueue(y)},close(){}})),d.pipeTo(new WritableStream({write(y){f.enqueue(y)},close(){f.close()}}))])}})}var _s=Pe({prefix:"aitxt",size:24}),Is=Pe({prefix:"msg",size:24});function to({model:e,tools:t,toolChoice:r,system:a,prompt:s,messages:n,maxRetries:o,abortSignal:l,headers:c,maxSteps:u=1,experimental_generateMessageId:d=Is,experimental_output:m,experimental_continueSteps:v=!1,experimental_telemetry:b,experimental_providerMetadata:x,providerOptions:C=x,experimental_toolCallStreaming:w=!1,toolCallStreaming:f=w,experimental_activeTools:y,experimental_repairToolCall:N,experimental_transform:h,onChunk:P,onError:k,onFinish:D,onStepFinish:O,_internal:{now:pe=Wr,generateId:F=_s,currentDate:V=()=>new Date}={},...ae}){return new Cs({model:e,telemetry:b,headers:c,settings:ae,maxRetries:o,abortSignal:l,system:a,prompt:s,messages:n,tools:t,toolChoice:r,toolCallStreaming:f,transforms:xs(h),activeTools:y,repairToolCall:N,maxSteps:u,output:m,continueSteps:v,providerOptions:C,onChunk:P,onError:k,onFinish:D,onStepFinish:O,now:pe,currentDate:V,generateId:F,generateMessageId:d})}function Rs(e){if(!e)return new TransformStream({transform(n,o){o.enqueue({part:n,partialOutput:void 0})}});let t="",r="",a="";function s({controller:n,partialOutput:o=void 0}){n.enqueue({part:{type:"text-delta",textDelta:r},partialOutput:o}),r=""}return new TransformStream({transform(n,o){if(n.type==="step-finish"&&s({controller:o}),n.type!=="text-delta"){o.enqueue({part:n,partialOutput:void 0});return}t+=n.textDelta,r+=n.textDelta;const l=e.parsePartial({text:t});if(l!=null){const c=JSON.stringify(l.partial);c!==a&&(s({controller:o,partialOutput:l.partial}),a=c)}},flush(n){r.length>0&&s({controller:n})}})}var Cs=class{constructor({model:e,telemetry:t,headers:r,settings:a,maxRetries:s,abortSignal:n,system:o,prompt:l,messages:c,tools:u,toolChoice:d,toolCallStreaming:m,transforms:v,activeTools:b,repairToolCall:x,maxSteps:C,output:w,continueSteps:f,providerOptions:y,now:N,currentDate:h,generateId:P,generateMessageId:k,onChunk:D,onError:O,onFinish:pe,onStepFinish:F}){this.warningsPromise=new M,this.usagePromise=new M,this.finishReasonPromise=new M,this.providerMetadataPromise=new M,this.textPromise=new M,this.reasoningPromise=new M,this.reasoningDetailsPromise=new M,this.sourcesPromise=new M,this.filesPromise=new M,this.toolCallsPromise=new M,this.toolResultsPromise=new M,this.requestPromise=new M,this.responsePromise=new M,this.stepsPromise=new M;var V;if(C<1)throw new R({parameter:"maxSteps",value:C,message:"maxSteps must be at least 1"});this.output=w;let ae="",ee="",ne="",se=[],be=[],J,xe=[];const de=[],oe={id:P(),timestamp:h(),modelId:e.modelId,messages:[]};let U=[],K=[],ie,te,Se="initial";const z=[];let re;const q=new TransformStream({async transform(B,G){G.enqueue(B);const{part:p}=B;if((p.type==="text-delta"||p.type==="reasoning"||p.type==="source"||p.type==="tool-call"||p.type==="tool-result"||p.type==="tool-call-streaming-start"||p.type==="tool-call-delta")&&await D?.({chunk:p}),p.type==="error"&&await O?.({error:p.error}),p.type==="text-delta"&&(ae+=p.textDelta,ee+=p.textDelta,ne+=p.textDelta),p.type==="reasoning"&&(J==null?(J={type:"text",text:p.textDelta},se.push(J)):J.text+=p.textDelta),p.type==="reasoning-signature"){if(J==null)throw new I({name:"InvalidStreamPart",message:"reasoning-signature without reasoning"});J.signature=p.signature,J=void 0}if(p.type==="redacted-reasoning"&&se.push({type:"redacted",data:p.data}),p.type==="file"&&be.push(p),p.type==="source"&&(de.push(p.source),xe.push(p.source)),p.type==="tool-call"&&U.push(p),p.type==="tool-result"&&K.push(p),p.type==="step-finish"){const $=nr({text:ee,files:be,reasoning:se,tools:u??{},toolCalls:U,toolResults:K,messageId:p.messageId,generateMessageId:k}),L=z.length;let X="done";L+1<C&&(f&&p.finishReason==="length"&&U.length===0?X="continue":U.length>0&&K.length===U.length&&(X="tool-result"));const Ge={stepType:Se,text:ae,reasoning:hs(se),reasoningDetails:se,files:be,sources:xe,toolCalls:U,toolResults:K,finishReason:p.finishReason,usage:p.usage,warnings:p.warnings,logprobs:p.logprobs,request:p.request,response:{...p.response,messages:[...oe.messages,...$]},providerMetadata:p.experimental_providerMetadata,experimental_providerMetadata:p.experimental_providerMetadata,isContinued:p.isContinued};await F?.(Ge),z.push(Ge),U=[],K=[],ae="",xe=[],se=[],be=[],J=void 0,X!=="done"&&(Se=X),X!=="continue"&&(oe.messages.push(...$),ee="")}p.type==="finish"&&(oe.id=p.response.id,oe.timestamp=p.response.timestamp,oe.modelId=p.response.modelId,oe.headers=p.response.headers,te=p.usage,ie=p.finishReason)},async flush(B){var G;try{if(z.length===0)return;const p=z[z.length-1];_.warningsPromise.resolve(p.warnings),_.requestPromise.resolve(p.request),_.responsePromise.resolve(p.response),_.toolCallsPromise.resolve(p.toolCalls),_.toolResultsPromise.resolve(p.toolResults),_.providerMetadataPromise.resolve(p.experimental_providerMetadata),_.reasoningPromise.resolve(p.reasoning),_.reasoningDetailsPromise.resolve(p.reasoningDetails);const $=ie??"unknown",L=te??{completionTokens:NaN,promptTokens:NaN,totalTokens:NaN};_.finishReasonPromise.resolve($),_.usagePromise.resolve(L),_.textPromise.resolve(ne),_.sourcesPromise.resolve(de),_.filesPromise.resolve(p.files),_.stepsPromise.resolve(z),await pe?.({finishReason:$,logprobs:void 0,usage:L,text:ne,reasoning:p.reasoning,reasoningDetails:p.reasoningDetails,files:p.files,sources:p.sources,toolCalls:p.toolCalls,toolResults:p.toolResults,request:(G=p.request)!=null?G:{},response:p.response,warnings:p.warnings,providerMetadata:p.providerMetadata,experimental_providerMetadata:p.experimental_providerMetadata,steps:z}),re.setAttributes(Z({telemetry:t,attributes:{"ai.response.finishReason":$,"ai.response.text":{output:()=>ne},"ai.response.toolCalls":{output:()=>{var X;return(X=p.toolCalls)!=null&&X.length?JSON.stringify(p.toolCalls):void 0}},"ai.usage.promptTokens":L.promptTokens,"ai.usage.completionTokens":L.completionTokens}}))}catch(p){B.error(p)}finally{re.end()}}}),le=Lr();this.addStream=le.addStream,this.closeStream=le.close;let ue=le.stream;for(const B of v)ue=ue.pipeThrough(B({tools:u,stopStream(){le.terminate()}}));this.baseStream=ue.pipeThrough(Rs(w)).pipeThrough(q);const{maxRetries:Je,retry:Be}=xr({maxRetries:s}),Ee=Tr(t),S=Sr({model:e,telemetry:t,headers:r,settings:{...a,maxRetries:Je}}),T=xt({prompt:{system:(V=w?.injectIntoSystemPrompt({system:o,model:e}))!=null?V:o,prompt:l,messages:c},tools:u}),_=this;$e({name:"ai.streamText",attributes:Z({telemetry:t,attributes:{...Ue({operationId:"ai.streamText",telemetry:t}),...S,"ai.prompt":{input:()=>JSON.stringify({system:o,prompt:l,messages:c})},"ai.settings.maxSteps":C}}),tracer:Ee,endWhenDone:!1,fn:async B=>{re=B;async function G({currentStep:p,responseMessages:$,usage:L,stepType:X,previousStepText:Ge,hasLeadingWhitespace:ma,messageId:Le}){var Dt;const rt=$.length===0?T.type:"messages",qt=[...T.messages,...$],Ut=await yt({prompt:{type:rt,system:T.system,messages:qt},modelSupportsImageUrls:e.supportsImageUrls,modelSupportsUrl:(Dt=e.supportsUrl)==null?void 0:Dt.bind(e)}),We={type:"regular",...is({tools:u,toolChoice:d,activeTools:b})},{result:{stream:fa,warnings:at,rawResponse:Ve,request:$t},doStreamSpan:Te,startTimestampMs:Ft}=await Be(()=>$e({name:"ai.streamText.doStream",attributes:Z({telemetry:t,attributes:{...Ue({operationId:"ai.streamText.doStream",telemetry:t}),...S,"ai.prompt.format":{input:()=>rt},"ai.prompt.messages":{input:()=>JSON.stringify(Ut)},"ai.prompt.tools":{input:()=>{var g;return(g=We.tools)==null?void 0:g.map(j=>JSON.stringify(j))}},"ai.prompt.toolChoice":{input:()=>We.toolChoice!=null?JSON.stringify(We.toolChoice):void 0},"gen_ai.system":e.provider,"gen_ai.request.model":e.modelId,"gen_ai.request.frequency_penalty":a.frequencyPenalty,"gen_ai.request.max_tokens":a.maxTokens,"gen_ai.request.presence_penalty":a.presencePenalty,"gen_ai.request.stop_sequences":a.stopSequences,"gen_ai.request.temperature":a.temperature,"gen_ai.request.top_k":a.topK,"gen_ai.request.top_p":a.topP}}),tracer:Ee,endWhenDone:!1,fn:async g=>({startTimestampMs:N(),doStreamSpan:g,result:await e.doStream({mode:We,...wt(a),inputFormat:rt,responseFormat:w?.responseFormat({model:e}),prompt:Ut,providerMetadata:y,abortSignal:n,headers:r})})})),ha=Ts({tools:u,generatorStream:fa,toolCallStreaming:m,tracer:Ee,telemetry:t,system:o,messages:qt,repairToolCall:x,abortSignal:n}),Jt=$t??{},me=[],nt=[],st=[],Bt=[];let fe,he="unknown",ce={promptTokens:0,completionTokens:0,totalTokens:0},Ae,Gt=!0,je="",Lt=X==="continue"?Ge:"",ot,H={id:P(),timestamp:h(),modelId:e.modelId},_e="",Wt=!1,Vt=!0,zt=!1;async function it({controller:g,chunk:j}){g.enqueue(j),je+=j.textDelta,Lt+=j.textDelta,Wt=!0,zt=j.textDelta.trimEnd()!==j.textDelta}_.addStream(ha.pipeThrough(new TransformStream({async transform(g,j){var Y,Me,ge;if(Gt){const Q=N()-Ft;Gt=!1,Te.addEvent("ai.stream.firstChunk",{"ai.response.msToFirstChunk":Q}),Te.setAttributes({"ai.response.msToFirstChunk":Q}),j.enqueue({type:"step-start",messageId:Le,request:Jt,warnings:at??[]})}if(g.type==="text-delta"&&g.textDelta.length===0)return;const Xt=g.type;switch(Xt){case"text-delta":{if(f){const Q=Vt&&ma?g.textDelta.trimStart():g.textDelta;if(Q.length===0)break;Vt=!1,_e+=Q;const ze=us(_e);ze!=null&&(_e=ze.suffix,await it({controller:j,chunk:{type:"text-delta",textDelta:ze.prefix+ze.whitespace}}))}else await it({controller:j,chunk:g});break}case"reasoning":{j.enqueue(g),fe==null?(fe={type:"text",text:g.textDelta},st.push(fe)):fe.text+=g.textDelta;break}case"reasoning-signature":{if(j.enqueue(g),fe==null)throw new ys({chunk:g,message:"reasoning-signature without reasoning"});fe.signature=g.signature,fe=void 0;break}case"redacted-reasoning":{j.enqueue(g),st.push({type:"redacted",data:g.data});break}case"tool-call":{j.enqueue(g),me.push(g);break}case"tool-result":{j.enqueue(g),nt.push(g);break}case"response-metadata":{H={id:(Y=g.id)!=null?Y:H.id,timestamp:(Me=g.timestamp)!=null?Me:H.timestamp,modelId:(ge=g.modelId)!=null?ge:H.modelId};break}case"finish":{ce=g.usage,he=g.finishReason,Ae=g.experimental_providerMetadata,ot=g.logprobs;const Q=N()-Ft;Te.addEvent("ai.stream.finish"),Te.setAttributes({"ai.response.msToFinish":Q,"ai.response.avgCompletionTokensPerSecond":1e3*ce.completionTokens/Q});break}case"file":{Bt.push(g),j.enqueue(g);break}case"source":case"tool-call-streaming-start":case"tool-call-delta":{j.enqueue(g);break}case"error":{j.enqueue(g),he="error";break}default:{const Q=Xt;throw new Error(`Unknown chunk type: ${Q}`)}}},async flush(g){const j=me.length>0?JSON.stringify(me):void 0;let Y="done";p+1<C&&(f&&he==="length"&&me.length===0?Y="continue":me.length>0&&nt.length===me.length&&(Y="tool-result")),f&&_e.length>0&&(Y!=="continue"||X==="continue"&&!Wt)&&(await it({controller:g,chunk:{type:"text-delta",textDelta:_e}}),_e="");try{Te.setAttributes(Z({telemetry:t,attributes:{"ai.response.finishReason":he,"ai.response.text":{output:()=>je},"ai.response.toolCalls":{output:()=>j},"ai.response.id":H.id,"ai.response.model":H.modelId,"ai.response.timestamp":H.timestamp.toISOString(),"ai.usage.promptTokens":ce.promptTokens,"ai.usage.completionTokens":ce.completionTokens,"gen_ai.response.finish_reasons":[he],"gen_ai.response.id":H.id,"gen_ai.response.model":H.modelId,"gen_ai.usage.input_tokens":ce.promptTokens,"gen_ai.usage.output_tokens":ce.completionTokens}}))}catch{}finally{Te.end()}g.enqueue({type:"step-finish",finishReason:he,usage:ce,providerMetadata:Ae,experimental_providerMetadata:Ae,logprobs:ot,request:Jt,response:{...H,headers:Ve?.headers},warnings:at,isContinued:Y==="continue",messageId:Le});const Me=Ln(L,ce);if(Y==="done")g.enqueue({type:"finish",finishReason:he,usage:Me,providerMetadata:Ae,experimental_providerMetadata:Ae,logprobs:ot,response:{...H,headers:Ve?.headers}}),_.closeStream();else{if(X==="continue"){const ge=$[$.length-1];typeof ge.content=="string"?ge.content+=je:ge.content.push({text:je,type:"text"})}else $.push(...nr({text:je,files:Bt,reasoning:st,tools:u??{},toolCalls:me,toolResults:nt,messageId:Le,generateMessageId:k}));await G({currentStep:p+1,responseMessages:$,usage:Me,stepType:Y,previousStepText:Lt,hasLeadingWhitespace:zt,messageId:Y==="continue"?Le:k()})}}})))}await G({currentStep:0,responseMessages:[],usage:{promptTokens:0,completionTokens:0,totalTokens:0},previousStepText:"",stepType:"initial",hasLeadingWhitespace:!1,messageId:k()})}}).catch(B=>{_.addStream(new ReadableStream({start(G){G.enqueue({type:"error",error:B}),G.close()}})),_.closeStream()})}get warnings(){return this.warningsPromise.value}get usage(){return this.usagePromise.value}get finishReason(){return this.finishReasonPromise.value}get experimental_providerMetadata(){return this.providerMetadataPromise.value}get providerMetadata(){return this.providerMetadataPromise.value}get text(){return this.textPromise.value}get reasoning(){return this.reasoningPromise.value}get reasoningDetails(){return this.reasoningDetailsPromise.value}get sources(){return this.sourcesPromise.value}get files(){return this.filesPromise.value}get toolCalls(){return this.toolCallsPromise.value}get toolResults(){return this.toolResultsPromise.value}get request(){return this.requestPromise.value}get response(){return this.responsePromise.value}get steps(){return this.stepsPromise.value}teeStream(){const[e,t]=this.baseStream.tee();return this.baseStream=t,e}get textStream(){return we(this.teeStream().pipeThrough(new TransformStream({transform({part:e},t){e.type==="text-delta"&&t.enqueue(e.textDelta)}})))}get fullStream(){return we(this.teeStream().pipeThrough(new TransformStream({transform({part:e},t){t.enqueue(e)}})))}async consumeStream(e){var t;try{await Ss({stream:this.fullStream,onError:e?.onError})}catch(r){(t=e?.onError)==null||t.call(e,r)}}get experimental_partialOutputStream(){if(this.output==null)throw new as;return we(this.teeStream().pipeThrough(new TransformStream({transform({partialOutput:e},t){e!=null&&t.enqueue(e)}})))}toDataStreamInternal({getErrorMessage:e=()=>"An error occurred.",sendUsage:t=!0,sendReasoning:r=!1,sendSources:a=!1,experimental_sendFinish:s=!0}){return this.fullStream.pipeThrough(new TransformStream({transform:async(n,o)=>{const l=n.type;switch(l){case"text-delta":{o.enqueue(E("text",n.textDelta));break}case"reasoning":{r&&o.enqueue(E("reasoning",n.textDelta));break}case"redacted-reasoning":{r&&o.enqueue(E("redacted_reasoning",{data:n.data}));break}case"reasoning-signature":{r&&o.enqueue(E("reasoning_signature",{signature:n.signature}));break}case"file":{o.enqueue(E("file",{mimeType:n.mimeType,data:n.base64}));break}case"source":{a&&o.enqueue(E("source",n.source));break}case"tool-call-streaming-start":{o.enqueue(E("tool_call_streaming_start",{toolCallId:n.toolCallId,toolName:n.toolName}));break}case"tool-call-delta":{o.enqueue(E("tool_call_delta",{toolCallId:n.toolCallId,argsTextDelta:n.argsTextDelta}));break}case"tool-call":{o.enqueue(E("tool_call",{toolCallId:n.toolCallId,toolName:n.toolName,args:n.args}));break}case"tool-result":{o.enqueue(E("tool_result",{toolCallId:n.toolCallId,result:n.result}));break}case"error":{o.enqueue(E("error",e(n.error)));break}case"step-start":{o.enqueue(E("start_step",{messageId:n.messageId}));break}case"step-finish":{o.enqueue(E("finish_step",{finishReason:n.finishReason,usage:t?{promptTokens:n.usage.promptTokens,completionTokens:n.usage.completionTokens}:void 0,isContinued:n.isContinued}));break}case"finish":{s&&o.enqueue(E("finish_message",{finishReason:n.finishReason,usage:t?{promptTokens:n.usage.promptTokens,completionTokens:n.usage.completionTokens}:void 0}));break}default:{const c=l;throw new Error(`Unknown chunk type: ${c}`)}}}}))}pipeDataStreamToResponse(e,{status:t,statusText:r,headers:a,data:s,getErrorMessage:n,sendUsage:o,sendReasoning:l,sendSources:c,experimental_sendFinish:u}={}){vt({response:e,status:t,statusText:r,headers:gt(a,{contentType:"text/plain; charset=utf-8",dataStreamVersion:"v1"}),stream:this.toDataStream({data:s,getErrorMessage:n,sendUsage:o,sendReasoning:l,sendSources:c,experimental_sendFinish:u})})}pipeTextStreamToResponse(e,t){vt({response:e,status:t?.status,statusText:t?.statusText,headers:gt(t?.headers,{contentType:"text/plain; charset=utf-8"}),stream:this.textStream.pipeThrough(new TextEncoderStream)})}toDataStream(e){const t=this.toDataStreamInternal({getErrorMessage:e?.getErrorMessage,sendUsage:e?.sendUsage,sendReasoning:e?.sendReasoning,sendSources:e?.sendSources,experimental_sendFinish:e?.experimental_sendFinish}).pipeThrough(new TextEncoderStream);return e?.data?Mt(e?.data.stream,t):t}mergeIntoDataStream(e,t){e.merge(this.toDataStreamInternal({getErrorMessage:e.onError,sendUsage:t?.sendUsage,sendReasoning:t?.sendReasoning,sendSources:t?.sendSources,experimental_sendFinish:t?.experimental_sendFinish}))}toDataStreamResponse({headers:e,status:t,statusText:r,data:a,getErrorMessage:s,sendUsage:n,sendReasoning:o,sendSources:l,experimental_sendFinish:c}={}){return new Response(this.toDataStream({data:a,getErrorMessage:s,sendUsage:n,sendReasoning:o,sendSources:l,experimental_sendFinish:c}),{status:t,statusText:r,headers:Ce(e,{contentType:"text/plain; charset=utf-8",dataStreamVersion:"v1"})})}toTextStreamResponse(e){var t;return new Response(this.textStream.pipeThrough(new TextEncoderStream),{status:(t=e?.status)!=null?t:200,headers:Ce(e?.headers,{contentType:"text/plain; charset=utf-8"})})}},Ps=i.object({name:i.string(),version:i.string()}).passthrough(),Nt=i.object({_meta:i.optional(i.object({}).passthrough())}).passthrough(),Fe=Nt,Es=i.object({method:i.string(),params:i.optional(Nt)}),As=i.object({experimental:i.optional(i.object({}).passthrough()),logging:i.optional(i.object({}).passthrough()),prompts:i.optional(i.object({listChanged:i.optional(i.boolean())}).passthrough()),resources:i.optional(i.object({subscribe:i.optional(i.boolean()),listChanged:i.optional(i.boolean())}).passthrough()),tools:i.optional(i.object({listChanged:i.optional(i.boolean())}).passthrough())}).passthrough();Fe.extend({protocolVersion:i.string(),capabilities:As,serverInfo:Ps,instructions:i.optional(i.string())});var js=Fe.extend({nextCursor:i.optional(i.string())}),Ms=i.object({name:i.string(),description:i.optional(i.string()),inputSchema:i.object({type:i.literal("object"),properties:i.optional(i.object({}).passthrough())}).passthrough()}).passthrough();js.extend({tools:i.array(Ms)});var Ns=i.object({type:i.literal("text"),text:i.string()}).passthrough(),Os=i.object({type:i.literal("image"),data:i.string().base64(),mimeType:i.string()}).passthrough(),pa=i.object({uri:i.string(),mimeType:i.optional(i.string())}).passthrough(),ks=pa.extend({text:i.string()}),Ds=pa.extend({blob:i.string().base64()}),qs=i.object({type:i.literal("resource"),resource:i.union([ks,Ds])}).passthrough();Fe.extend({content:i.array(i.union([Ns,Os,qs])),isError:i.boolean().default(!1).optional()}).or(Fe.extend({toolResult:i.unknown()}));var tt="2.0",Us=i.object({jsonrpc:i.literal(tt),id:i.union([i.string(),i.number().int()])}).merge(Es).strict(),$s=i.object({jsonrpc:i.literal(tt),id:i.union([i.string(),i.number().int()]),result:Fe}).strict(),Fs=i.object({jsonrpc:i.literal(tt),id:i.union([i.string(),i.number().int()]),error:i.object({code:i.number().int(),message:i.string(),data:i.optional(i.unknown())})}).strict(),Js=i.object({jsonrpc:i.literal(tt)}).merge(i.object({method:i.string(),params:i.optional(Nt)})).strict();i.union([Us,Js,$s,Fs]);var Bs={};jt(Bs,{mergeIntoDataStream:()=>Ws,toDataStream:()=>Gs,toDataStreamResponse:()=>Ls});function da(e={}){const t=new TextEncoder;let r="";return new TransformStream({async start(){e.onStart&&await e.onStart()},async transform(a,s){s.enqueue(t.encode(a)),r+=a,e.onToken&&await e.onToken(a),e.onText&&typeof a=="string"&&await e.onText(a)},async flush(){e.onCompletion&&await e.onCompletion(r),e.onFinal&&await e.onFinal(r)}})}function Ot(e,t){return e.pipeThrough(new TransformStream({transform:async(r,a)=>{var s;if(typeof r=="string"){a.enqueue(r);return}if("event"in r){r.event==="on_chat_model_stream"&&sr((s=r.data)==null?void 0:s.chunk,a);return}sr(r,a)}})).pipeThrough(da(t)).pipeThrough(new TextDecoderStream).pipeThrough(new TransformStream({transform:async(r,a)=>{a.enqueue(E("text",r))}}))}function Gs(e,t){return Ot(e,t).pipeThrough(new TextEncoderStream)}function Ls(e,t){var r;const a=Ot(e,t?.callbacks).pipeThrough(new TextEncoderStream),s=t?.data,n=t?.init,o=s?Mt(s.stream,a):a;return new Response(o,{status:(r=n?.status)!=null?r:200,statusText:n?.statusText,headers:Ce(n?.headers,{contentType:"text/plain; charset=utf-8",dataStreamVersion:"v1"})})}function Ws(e,t){t.dataStream.merge(Ot(e,t.callbacks))}function sr(e,t){if(typeof e.content=="string")t.enqueue(e.content);else{const r=e.content;for(const a of r)a.type==="text"&&t.enqueue(a.text)}}var Vs={};jt(Vs,{mergeIntoDataStream:()=>Hs,toDataStream:()=>zs,toDataStreamResponse:()=>Xs});function kt(e,t){const r=Ks();return xa(e[Symbol.asyncIterator]()).pipeThrough(new TransformStream({async transform(a,s){s.enqueue(r(a.delta))}})).pipeThrough(da(t)).pipeThrough(new TextDecoderStream).pipeThrough(new TransformStream({transform:async(a,s)=>{s.enqueue(E("text",a))}}))}function zs(e,t){return kt(e,t).pipeThrough(new TextEncoderStream)}function Xs(e,t={}){var r;const{init:a,data:s,callbacks:n}=t,o=kt(e,n).pipeThrough(new TextEncoderStream),l=s?Mt(s.stream,o):o;return new Response(l,{status:(r=a?.status)!=null?r:200,statusText:a?.statusText,headers:Ce(a?.headers,{contentType:"text/plain; charset=utf-8",dataStreamVersion:"v1"})})}function Hs(e,t){t.dataStream.merge(kt(e,t.callbacks))}function Ks(){let e=!0;return t=>(e&&(t=t.trimStart(),t&&(e=!1)),t)}export{eo as a,Zs as c,to as s};
